default:
  image: registry.timmertech.nl/docker/docker:latest

stages:
  - build
  - multi
  - dockerhub
  - trigger

include:
  - project: templates/ci
    file: docker.yml

variables:
  ALPINE_VERSION: "3.18"

.build:
  extends: .docker-build-multi
  variables:
    DOCKER_PROXY_HOST: "ghcr.io"
    PLATFORM: "linux/arm64,linux/amd64"
    BUILD_ARGS: >-
      --build-arg ALPINE_VERSION=${ALPINE_VERSION}

amd64:
  extends: .docker-build-amd64
  variables:
    DOCKER_PROXY_HOST: "ghcr.io"
    BUILD_ARGS: >-
      --build-arg=ALPINE_VERSION=${ALPINE_VERSION}

arm64:
  extends: .docker-build-arm64
  variables:
    DOCKER_PROXY_HOST: "ghcr.io"
    BUILD_ARGS: >-
      --build-arg=ALPINE_VERSION=${ALPINE_VERSION}

multi:
  extends: .build
  stage: multi
  variables:
    PLATFORM: "linux/arm64,linux/amd64"
    DOCKER_HUB: "ENABLED"
    DOCKER_TAGS: >-
      --tag=${DOCKER_IMAGE_PATH}:latest
      --tag=${DOCKER_IMAGE_HUB_PATH}:latest

release:
  extends: .build
  variables:
    DOCKER_HUB: "ENABLED"
    DOCKER_IMAGE: ${DOCKER_IMAGE_PATH}:${CI_COMMIT_TAG}
    DOCKER_TAGS: >-
      --tag=${DOCKER_IMAGE_HUB_PATH}:${CI_COMMIT_TAG}
  only:
    - tags

alpine-glibc:
  stage: trigger
  only:
    - main
    - schedules
  trigger:
    forward:
      yaml_variables: false
      pipeline_variables: false
    project: docker/alpine-glibc

alpine-sdk:
  stage: trigger
  only:
    - main
    - schedules
  trigger:
    forward:
      yaml_variables: false
      pipeline_variables: false
    project: docker/alpine-sdk

# bumpver:
#   stage: trigger
#   only:
#     - main
#     - schedules
#   trigger:
#     forward:
#       yaml_variables: false
#       pipeline_variables: false
#     project: docker/bumpver

# git-conventional-commits:
#   stage: trigger
#   only:
#     - main
#     - schedules
#   trigger:
#     forward:
#       yaml_variables: false
#       pipeline_variables: false
#     project: docker/git-conventional-commits

# shellcheck:
#   stage: trigger
#   only:
#     - main
#     - schedules
#   trigger:
#     forward:
#       yaml_variables: false
#       pipeline_variables: false
#     project: docker/shellcheck

# release-cli:
#   stage: trigger
#   only:
#     - main
#     - schedules
#   trigger:
#     forward:
#       yaml_variables: false
#       pipeline_variables: false
#     project: docker/release-cli

publish:
  stage: trigger
  only:
    - main
    - schedules
  trigger:
    forward:
      yaml_variables: false
      pipeline_variables: false
    project: tools/publish

chkver:
  stage: trigger
  only:
    - main
    - schedules
  trigger:
    forward:
      yaml_variables: false
      pipeline_variables: false
    project: tools/chkver

postgresql:
  stage: trigger
  only:
    - main
    - schedules
  trigger:
    forward:
      yaml_variables: false
      pipeline_variables: false
    project: docker/postgresql

redis:
  stage: trigger
  only:
    - main
    - schedules
  trigger:
    forward:
      yaml_variables: false
      pipeline_variables: false
    project: docker/redis
